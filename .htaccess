#################################################
# BASE HARDENING
#################################################
Options -Indexes
ServerSignature Off
FileETag None

#################################################
# SECURITY HEADERS
#################################################
<IfModule mod_headers.c>
    Header always unset X-Powered-By
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    #################################################
    # üîê CSP (PREPARADO PARA NONCE LARAVEL)
    #################################################

    # Laravel deve injetar nonce dinamicamente
    # Exemplo: nonce-{{ csp_nonce() }}

    Header always set Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'nonce-%{CSP_NONCE}e' https:;
        style-src 'self' 'nonce-%{CSP_NONCE}e' https:;
        img-src 'self' data: https:;
        font-src 'self' data: https:;
        connect-src 'self' https:;
        object-src 'none';
        frame-ancestors 'self';
        base-uri 'self';
        form-action 'self';
    "
</IfModule>

#################################################
# üõ° BLOQUEIO XML-RPC (WordPress abuse comum)
#################################################
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/xmlrpc\.php [NC]
    RewriteRule ^ - [F,L]
</IfModule>

#################################################
# üß† BLOQUEIO B√ÅSICO SQL INJECTION
#################################################
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (union|select|insert|drop|update|benchmark|sleep|information_schema) [NC,OR]
    RewriteCond %{QUERY_STRING} (concat\(|char\(|0x[0-9A-F]+) [NC,OR]
    RewriteCond %{QUERY_STRING} (\%27)|(\')|(\-\-) [NC]
    RewriteRule ^ - [F,L]
</IfModule>

#################################################
# üö´ BLOQUEIO DE USER AGENTS MALICIOSOS
#################################################
<IfModule mod_setenvif.c>
    SetEnvIfNoCase User-Agent "curl" bad_bot
    SetEnvIfNoCase User-Agent "wget" bad_bot
    SetEnvIfNoCase User-Agent "python" bad_bot
    SetEnvIfNoCase User-Agent "nikto" bad_bot
    SetEnvIfNoCase User-Agent "sqlmap" bad_bot
    SetEnvIfNoCase User-Agent "masscan" bad_bot
    SetEnvIfNoCase User-Agent "nmap" bad_bot

    <RequireAll>
        Require all granted
        Require not env bad_bot
    </RequireAll>
</IfModule>

#################################################
# üîé HONEYPOT INVIS√çVEL
#################################################
# Se algu√©m tentar acessar rota honeypot ‚Üí bloqueia IP
<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_URI} ^/admin-login\.php [NC,OR]
    RewriteCond %{REQUEST_URI} ^/wp-admin [NC,OR]
    RewriteCond %{REQUEST_URI} ^/phpmyadmin [NC]
    RewriteRule ^ - [F,L]
</IfModule>

#################################################
# üî• HOTLINK PROTECTION
#################################################
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?seudominio\.com [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,NC]
</IfModule>

#################################################
# üß± RATE LIMIT B√ÅSICO
#################################################
<IfModule mod_ratelimit.c>
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 500
    </Location>
</IfModule>

#################################################
# GZIP
#################################################
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/javascript application/json
</IfModule>

#################################################
# CACHE
#################################################
<IfModule mod_expires.c>
    ExpiresActive On

    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
</IfModule>

#################################################
# FRONT CONTROLLER
#################################################
<IfModule mod_rewrite.c>
    RewriteEngine On

    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^ index.php [L]
</IfModule>
